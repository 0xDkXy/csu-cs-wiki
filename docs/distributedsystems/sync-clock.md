# 时间同步算法

## 概述

分布式系统中，时间一个重要的问题

- 时间是我们想要精确度量的量
- 很多算法依赖于时钟同步（或者说，从单机迁移至分布式系统的一些算法需要保证在单机环境下的时钟同步性质）

在分布式系统中，物理时间的概念也是不准确的。这不是由于相对性的影响，相对性在常规计算机中可以忽略或不存在，主要是问题是：受目前技术能力的限制，不能准确记录不同结点上的事件的时间，以便知道事件发生的顺序或事件是否同时发生。

所以就造成了如下困境。**分布式系统中没有绝对的全局时间**，**但却需要确定一些事件状态的先后顺序（“同时”发生）**。

## 物理时钟

物理时钟是最先能想到的时间同步方法，但是由于分布式系统中不同节点有不同时钟值。时钟值各自孤立是无意义的，我们需要途径将他们组织起来尽可能达成一致/同步。我们可以在实际时间的一个**区间**上定义两个同步模式：

- 外部同步（external synchronization）

      - 为了知道分布式系统 P 的进程中事件发生的具体时间，有必要用权威的外部时间源同步进程的时钟$C_i$
      - 设一个同步范围$D>0$，UTC 时间源为$S$，$I$中的所有实际时间$t$，满足$|S(t)-C_i(t)|<D$，其中$i=1,2, \cdots ,N$。软件时钟$C_i$在范围$D$中是准确的。

- 内部同步（internal synchronization）

      - 如果时钟$C_i$与其他时钟同步到一个已知的精度，那么我们就能通过本地时钟度量在不同计算机上发生的两个事件的间隔
      - 设同步范围$D>0$，$I$中所有实际时间$t$，则有$|C_i(t)-C_j(t)|<D$，其中$i,j=1,2, \cdots ,N$。时钟$C_i$在范围$D$中是一致的。
      - 内部同步的时钟未必是外部同步的。（在外部 UTC 确定情况下，可能距离各时钟分布的时间范围很远）。

- 一个推论：如果系统 P 在范围 D 内是外部同步的，那么该系统在范围 2D 内是内部同步的。

~~初学的时候莫名回忆起了函数的一致连续性和绝对连续性~~，推论你可以这么理解，时间轴上极差最大的两个时钟，临界情况$D = \frac{C(t)_{max}- C(t)_{min}}{2}$，那么最远距离就是$2D$，所以各点间距均在$2D$范围内。

## 时间同步算法

下面着重讲解一些典型的时间同步算法

### Christian 算法

- 时间服务器，可接受 WWV 的 UTC 时间$C_{UTC}$（标准时间）
- 每隔$δ/(2ρ)$，客户机$i$向服务器询问时间
- 服务器返回$C_{UTC}$
- 客户机$i$校正自己时间，$C_i=C_{UTC}+TransTime$
- $TransTime=\frac{(T_1-T_0-I)}{2}$

      - $T_0$：请求的本地时间
      - $T_1$：到达的本地时间
      - $I$:中断处理时间
      - 假定双向路径相同

- 优化处理

      - 设定传播阈值,超出阈值，认定无效

### Berkeley 算法

时间守护进程（时间服务器）定期地询问每台机器的时间。然后基于这些回答计算出平均值并告诉所有的机器将它们的时钟拨快或拨慢到一个新的值（适合于没有 WWV 接收器的系统）。下面以 2 台节点服务器和 1 台节点服务器的时间矫正过程为例：

- 时间服务器向 node 1 和 node2 广播服务器时间$T_0 = 740$，
- node 1 返回其本地当前时间（加延迟）为$T_1 = 724+10 = 734$
- node 2 返回其本地当前时间（加延迟）为$T_2 = 738+5 = 743$
- 时间服务器计算平均时间$T_0' = 739$。
- 时间服务器通知 node 1：向前拨$5$
- 时间服务器通知 node 2：放慢时钟$4$

### 平均值算法

- 划分固定时间间隔$R$;
在每个间隔，所有机器广播自己的时钟时间
启动本地计时器收集在S时间间隔中到达的其他机器广播的时间
执行平均时间计算算法，得到新的时间值
