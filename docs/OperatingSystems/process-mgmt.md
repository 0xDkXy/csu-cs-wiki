# 进程管理

## 进程与线程

### 进程的概念

设计概念（数学不规范的 Specification）：在多道程序环境下，允许多个程序并发执行，此时它们将失去封闭性，并具有间歇性不可再现性的特征（单道的确定性被破坏？）。为此引入了进程（Process）的概念，以便更好描述和控制程序的并发执行，实现操作系统的并发性和共享性（最基本的两个特征），进程曾是分时系统的基本运作单位（面向进程设计的系统），现代系统中多作为线程的容器（面向线程设计的系统）。

具体实现（实体描述 Implementation）：为了使参与并发执行的程序（含数据）能独立地运行，必须为之配置一个专门的数据结构，称为**进程控制块**（Process Control Block，PCB）。系统利用 PCB 来描述进程的基本情况和运行状态，进而控制和管理进程。相应地，由**程序段**、**相关数据段**和**PCB**三部分构成了进程映像（进程实体）。

注意：PCB 是进程存在的**唯一标识**！

引入进程实体概念后，我们可以把进程定义为：“进程是进程实体的运行过程（抽象实现），是系统进行资源分配和调度的一个独立单位。”

### 进程的特征

进程的性质描述。

1. **动态性**：进程是程序的一次执行，有执行状态和生命周期。
2. **并发性**：多个进程实体同时存在内存中，能够在**一段时间内同时执行**（联系并发 concurrency 的概念）。并发是进程的重要特征。
3. **独立性**：进程实体是一个能够独立运行、独立获得资源和独立接受调度的基本单位（对于面向进程设计的操作系统而言）。
4. **异步性**：进程的相互制约，使得进程具有执行的间断性，即进程按各自独立的、不可预知的速度向前推进。异步性会导致执行结果的不可再现性，为此在操作系统中必须配置相应的进程同步机制。
5. **结构性**：指描述进程的 PCB 实体数据结构，从执行时构成看，进程结构是由程序段、数据段和进程控制段三部分构成。

### 进程的阻塞和唤醒

这里描述的进程阻塞过程和唤醒过程实际上就对应了后面一小节，其他调度参见[调度](#调度)的短期调度

正在执行的进程，由于期待的某些事件未发生，由系统自动执行阻塞原语`Block`，使自己由运行态变为阻塞态。可见，进程的阻塞时进程自身的一种主动行为（或者理解为内核行为），也因此只有处于运行态的进程（获得 CPU），才可能将其转换为阻塞态。操作：找 PCB、改未阻塞态、插入等待队列。

当阻塞进程所期待的事件出现时，如它所启动的 I/O 操作已完成或其所期待的数据已到达，由有关进程（如提供数据的进程）调用唤醒原语`Wakeup`，将等待该事件的进程唤醒。操作：找 PCB、从等待队列中移出、置就绪态、插入就绪队列等待调度器调度。

### 上下文

上下文切换（switch）的“上下文”，也即开销来源。在计算机科学中，任务（task）的上下文（英语：context）是一个任务所必不可少的一组数据（该任务可以是进程、线程）。这些数据允许任务中断，在这之后仍可在同一个地方继续执行（现场情况）。上下文的这一概念在中断的任务的场景下具有重大意义，其中，任务在被中断之后，处理器保存上下文并提供中断处理（interrupt service routine）。因此，上下文越小，延迟越小。

上下文的数据可能存放于处理器寄存器、任务所利用的内存、某些操作系统管理的任务所使用的控制寄存器（control registers）。

（笔者自己的调查）针对放置在寄存器（Register）还是内存（Memory）中我个人看法如下：

- 寄存器：最小执行单位（进程/线程）处就绪态时，CPU 利用寄存器内容做计算，此时上下文数据通过 Load/Store（假定 ARM 指令集）将上下文相关数据从内存传送至寄存器
- 任务所用内存：最小执行单位（进程/线程）处于阻塞态时，不利用 CPU 时间，此时上下文数据应在内存中保存。

中期调度——挂起的时候应该会把上下文也储存在磁盘上？

### 进程切换

对于通常的进程而言，其创建、撤销及要求由系统设备完成的 I/O 操作，都是利用系统调用而进入内核，再由内核中的相应处理程序予以完成的。进程切换同样是在内核的支持下实现的，因此可以说，任何进程都是在操作系统内核的支持下运行的，是与内核紧密相关的。

进程切换是指处理机从一个进程的运行转到另一个进程上运行，在这个过程中，进程的运行环境产生实质性变化。进程切换的过程如下:

1. 保存处理机的上下文，包括程序计数器和其他寄存器。
2. 更新 PCB 信息。
3. 把进程的 PCB 移入相应的队列，如就绪、在某事件的阻塞等队列。
4. 选择另一个进程执行，并更新其 PCB。
5. 更新内存管理的数据结构。
6. 恢复处理机上下文（所选择的另一个进程）

### 线程的概念

引入进程的目的是为了更好地使多道程序并发执行，提高资源利用率和系统吞吐量，增加并发度；而引入线程地目的则是为了减小程序在并发执行时所付出地时空开销，提高操作系统的并发性能。

线程最直接的理解就是“轻量级进程”，是一个基本的 CPU 执行单元，也是程序执行流的最小单元，由线程 ID、程序计数器、寄存器集合和堆栈组成。线程是进程中的一个实体，是被系统独立调度和分派的基本单位，线程自己不拥有系统资源，与其他线程共享进程所拥有的资源。一个线程可以创建和撤销另一个线程，同一个进程中给的多个线程之间可以并发执行。由于线程之间的相互制约，致使线程在运行中呈现出间断性。线程也有就绪、阻塞和运行三种基本状态。

### 线程的属性

1. **线程是一个轻型实体**
2. **不同的线程可以执行相同的程序段**
3. **共享资源**：进程容器所拥有的资源
4. **独立调度**：线程是处理机的独立调度的单位，多个线程可以并发执行（多核可以达成并行）。在单计算核心的计算机系统中，线程交替使用 CPU 时间；在多计算核心的系统中，各线程可同时占用不同的核心。

### 线程和进程的比较

<!-- TODO -->

待补充

## 调度

### 调度层次

1. **高级调度**：又称作业调度，其主要任务是按一定的原则从外存上处于后备状态的作业中挑选一个（或多个）作业，装载入内存，建立相应的进程。
2. **中级调度**：又称内存调度，其作用是提高内存利用率和系统吞吐量。为此，应将那些暂时不能运行的进程调至外存等待，把此时的进程状态称为**挂起态**。当它们已具备运行条件且内存又稍有空闲时，由中级调度来决定把外存上的那些已具备运行条件的就绪进程，再重新调入内存，并修改其状态未**就绪态**，挂在就绪队列上等待。
3. **低级调度**：又称低级调度，其主要任务是按照某种方法和策略从就绪队列中选取一个进程，将处理机分配给它。进程调度是操作系统中最基本的一种调度，在一般的操作系统中都必须配置进程调度。进程调度的频率很高，一般几十毫秒一次。
